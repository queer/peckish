use std::path::PathBuf;
use std::time::{SystemTime, UNIX_EPOCH};

use color_eyre::Result;

use crate::util::config::Injection;
use crate::util::MemoryFS;

use super::tarball::{TarballArtifact, TarballProducer};
use super::{get_artifact_size, Artifact, ArtifactProducer};

#[derive(Debug, Clone)]
pub struct ArchArtifact {
    pub name: String,
    pub path: PathBuf,
}

#[async_trait::async_trait]
impl Artifact for ArchArtifact {
    fn name(&self) -> &str {
        &self.name
    }

    fn description(&self) -> &str {
        "an arch linux package"
    }

    async fn extract(&self) -> Result<MemoryFS> {
        TarballArtifact {
            name: format!("{}-tarball-extractor", self.name),
            path: self.path.clone(),
        }
        .extract()
        .await
    }
}

#[derive(Debug, Clone)]
pub struct ArchProducer {
    pub name: String,
    pub path: PathBuf,
    pub injections: Vec<Injection>,
}

#[async_trait::async_trait]
impl ArtifactProducer for ArchProducer {
    type Output = ArchArtifact;

    fn name(&self) -> &str {
        &self.name
    }

    fn injections(&self) -> &[Injection] {
        &self.injections
    }

    async fn produce(&self, previous: &dyn Artifact) -> Result<Self::Output> {
        // TODO: .PKGINFO from user config
        /*
         * # generated by peckish
         * # :^)
         * pkgname = "foo"
         * pkgbase = "foo"
         * pkgver = 1.0.0
         * pkgdesc = "a foo that bars"
         * url: "https://example.com/foo"
         * builddate = 1234567890 # unix time
         * packager = "unknown"
         * size = 1234567890 # bytes
         * arch = "x86_64"
         * license = "custom"
         * provides = "foo"
         * depend = "bar"
         * depend = "baz"
         * optdepend = "quux"
         */

        let size = get_artifact_size(previous).await?;

        // TODO:
        // - Correct version (pacman says invalid)
        // - Get author and desc from params
        let content = indoc::formatdoc! {r#"
            # generated by peckish
            pkgname = {0}
            pkgbase = {0}
            pkgver = 1.0.0-1
            pkgdesc = {0} package generated by peckish
            builddate = {1}
            packager = {2}
            size = {3}
            arch = x86_64
            provides = "{0}"
        "#, self.name, SystemTime::now().duration_since(UNIX_EPOCH)?.as_secs(), "unknown packager", size };

        let mut new_injections = self.injections.clone();
        new_injections.push(Injection::Create {
            path: PathBuf::from(".PKGINFO"),
            content: content.clone().into(),
        });
        new_injections.push(Injection::Create {
            path: PathBuf::from(".BUILDINFO"),
            content: content.clone().into(),
        });

        TarballProducer {
            name: format!("{}-tarball-producer", self.name),
            path: self.path.clone(),
            injections: new_injections,
        }
        .produce(previous)
        .await
        .map(|tarball| ArchArtifact {
            name: self.name.clone(),
            path: tarball.path,
        })
    }
}
